<VirtualHost *:80>
     ServerName "{{ idp_fqdn }}"
     Redirect "/" "https://{{ idp_fqdn }}/"
</VirtualHost>

<VirtualHost *:443>
    ServerName "{{ idp_fqdn }}"
	ServerAdmin "{{ idp_admin_email }}"
	CustomLog /var/log/apache2/{{ idp_fqdn }}-access.log combined
	ErrorLog /var/log/apache2/{{ idp_fqdn }}-error.log

	Alias "/css" "/var/www/css"
	DocumentRoot /var/www/html/{{ idp_fqdn }}

    SSLProtocol All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH"
    SSLHonorCipherOrder on
    # Disable SSL Compression
    SSLCompression Off

    # OCSP Stapling, only in httpd/apache >= 2.3.3
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    # Enable HTTP Strict Transport Security with a 2 year duration
    Header always set Strict-Transport-Security "max-age=63072000;includeSubDomains;preload"

	SSLCertificateFile /etc/ssl/certs/{{ domain }}/{{ idp_fqdn }}-cert.pem	
	SSLCertificateKeyFile /etc/ssl/certs/{{ domain }}/{{ idp_fqdn }}-key.pem
    # SSLCertificateChainFile /root/certificates/DigiCertCA.pem
    
    <IfModule mod_proxy.c>
        SSLStaplingCache shmcb:/var/run/ocsp(128000)

        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "https"
        ProxyPass /idp http://localhost:8080/idp retry=5
        ProxyPassReverse /idp http://localhost:8080/idp retry=5
    
        <Location /idp>
           Require all granted
        </Location>
    </IfModule>

</VirtualHost>
